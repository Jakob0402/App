<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta charset="UTF-8">
<title>Barcode Scanner</title>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<style>
body { font-family: Arial; text-align: center; padding: 20px; }
#countdown { font-size: 24px; margin-top: 20px; color: #007bff; }
</style>
</head>
<body>

<h2>üîç Barcode wird analysiert‚Ä¶</h2>
<div id="countdown">Gesch√§tzte Restzeit: Berechnung...</div>

<script>
// Bild aus LocalStorage
const imgData = localStorage.getItem("scanImage");
if (!imgData) {
    document.body.innerHTML = "<p>‚ùå Kein Foto gefunden.</p>";
}

// Countdown-Element
const countdownEl = document.getElementById("countdown");

// Dynamische Sch√§tzung
let startTime = Date.now();
let framesProcessed = 0;
let barcodeDetected = false;

// Quagga initialisieren
Quagga.decodeSingle({
    decoder: { readers: ["ean_reader", "ean_13_reader"] },
    src: imgData
}, function(result) {
    barcodeDetected = true;

    if (!result || !result.codeResult) {
        countdownEl.textContent = "‚ùå Barcode nicht erkannt!";
        return;
    }

    const isbn = result.codeResult.code;
    countdownEl.textContent = "‚úÖ Barcode erkannt: " + isbn;

    // ISBN an Netlify Function senden
    fetch(`/.netlify/functions/fetchisbn?code=${isbn}`)
        .then(res => res.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, "text/html");

            const title = doc.querySelector("h1")?.innerText || "Unbekannt";
            const author = doc.querySelector(".author")?.innerText || "Unbekannt";
            const year = [...doc.querySelectorAll("li")]
                .find(li => li.innerText.includes("Erscheinungsjahr"))
                ?.innerText.replace("Erscheinungsjahr:", "").trim() || "Unbekannt";

            // Zur√ºck zu index.html
            window.location.href =
                `index.html?title=${encodeURIComponent(title)}` +
                `&author=${encodeURIComponent(author)}` +
                `&year=${encodeURIComponent(year)}` +
                `&isbn=${isbn}`;
        });
});

// Simuliere Frame-Verarbeitung, um dynamische Restzeit anzuzeigen
const countdownInterval = setInterval(() => {
    if (barcodeDetected) {
        clearInterval(countdownInterval);
        return;
    }

    framesProcessed++;
    const elapsed = (Date.now() - startTime) / 1000; // Sekunden
    // Annahme: durchschnittlich 15 Frames n√∂tig ‚Üí restliche Frames sch√§tzen
    const avgTimePerFrame = elapsed / framesProcessed;
    const estimatedRemaining = Math.max(0, Math.round(avgTimePerFrame * (15 - framesProcessed)));

    countdownEl.textContent = `Gesch√§tzte Restzeit: ${estimatedRemaining}s`;
}, 1000);
</script>

</body>
</html>

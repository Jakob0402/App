<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Barcode Scanner</title>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>
<body>
<h2>üîç Barcode wird analysiert‚Ä¶</h2>

<script>
const params = new URLSearchParams(window.location.search);
const imgData = params.get("img");

if (!imgData) {
    document.body.innerHTML = "<p>‚ùå Kein Bild gefunden.</p>";
}

Quagga.decodeSingle({
    decoder: { readers: ["ean_reader", "ean_13_reader"] },
    src: imgData
}, function(result) {
    if (!result || !result.codeResult) {
        document.body.innerHTML = "<p>‚ùå Kein Barcode gefunden.</p>";
        return;
    }

    const isbn = result.codeResult.code;

    // ISBN an Netlify Function schicken
    fetch(`/.netlify/functions/fetchisbn?code=${isbn}`)
        .then(res => res.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, "text/html");

            const title = doc.querySelector("h1")?.innerText || "Unbekannt";
            const author = doc.querySelector(".author")?.innerText || "Unbekannt";

            const year = [...doc.querySelectorAll(".book-details li")]
                .find(li => li.innerText.includes("Erscheinungsjahr"))
                ?.innerText.replace("Erscheinungsjahr:", "")
                .trim() || "Unbekannt";

            // Zur√ºck zu index.html
            window.location.href =
                `index.html?title=${encodeURIComponent(title)}` +
                `&author=${encodeURIComponent(author)}` +
                `&year=${encodeURIComponent(year)}` +
                `&isbn=${isbn}`;
        });
});
</script>

</body>
</html>

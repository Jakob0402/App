<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Barcode Scanner</title>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<style>
body { font-family: Arial; text-align: center; padding: 20px; }
#countdown { font-size: 24px; margin-top: 10px; color: #007bff; }
#step { font-size: 18px; margin-top: 5px; color: #555; }
</style>
</head>
<body>

<h2>üîç Barcode wird analysiert‚Ä¶</h2>
<div id="countdown">Gesch√§tzte Restzeit: Berechnung...</div>
<div id="step">Schritt: Initialisierung</div>

<script>
// Bild aus LocalStorage
const imgData = localStorage.getItem("scanImage");
if (!imgData) {
    document.body.innerHTML = "<p>‚ùå Kein Foto gefunden.</p>";
}

// DOM Elemente
const countdownEl = document.getElementById("countdown");
const stepEl = document.getElementById("step");

// Countdown & Status
let countdownSec = 15; // maximale Wartezeit
let barcodeDetected = false;
let resultShown = false;

// Interval zur Aktualisierung
const interval = setInterval(() => {
    if (resultShown) {
        clearInterval(interval);
        return;
    }

    countdownEl.textContent = `Gesch√§tzte Restzeit: ${countdownSec}s`;

    countdownSec--;

    // Countdown = 0 ‚Üí Zeige Ergebnis oder Fehler
    if (countdownSec < 0) {
        clearInterval(interval);
        stepEl.textContent = "‚è± Zeit abgelaufen";
        if (!barcodeDetected) {
            countdownEl.textContent = "‚ùå Barcode konnte nicht erkannt werden.";
            resultShown = true;
        }
    }
}, 1000);

// Schrittanzeige
function updateStep(text) {
    stepEl.textContent = "Schritt: " + text;
}

// Barcode erkennen
updateStep("Barcode wird erkannt...");
Quagga.decodeSingle({
    decoder: { readers: ["ean_reader", "ean_13_reader"] },
    src: imgData
}, function(result) {
    barcodeDetected = true;
    updateStep("Barcode erkannt, Buchdaten abrufen...");

    if (!result || !result.codeResult) {
        countdownEl.textContent = "‚ùå Barcode nicht erkannt!";
        resultShown = true;
        return;
    }

    const isbn = result.codeResult.code;
    countdownEl.textContent = "‚úÖ Barcode erkannt: " + isbn;

    // ISBN.de abfragen
    fetch(`/.netlify/functions/fetchisbn?code=${isbn}`)
        .then(res => res.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, "text/html");

            const title = doc.querySelector("h1")?.innerText || "Unbekannt";
            const author = doc.querySelector(".author")?.innerText || "Unbekannt";
            const year = [...doc.querySelectorAll("li")]
                .find(li => li.innerText.includes("Erscheinungsjahr"))
                ?.innerText.replace("Erscheinungsjahr:", "").trim() || "Unbekannt";

            // Ergebnis anzeigen ‚Üí zur√ºck zu index.html
            updateStep("Buchdaten abgerufen, Weiterleitung...");
            resultShown = true;

            window.location.href =
                `index.html?title=${encodeURIComponent(title)}` +
                `&author=${encodeURIComponent(author)}` +
                `&year=${encodeURIComponent(year)}` +
                `&isbn=${isbn}`;
        })
        .catch(err => {
            countdownEl.textContent = "‚ùå Fehler beim Abrufen der Buchdaten.";
            updateStep("Fehler");
            resultShown = true;
        });
});
</script>

</body>
</html>
